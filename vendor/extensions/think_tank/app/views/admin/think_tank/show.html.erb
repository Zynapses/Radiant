<%# 
  Think Tank Episode Detail View
  Shows full details of a specific episode including artifacts
%>

<%= stylesheet_link_tag 'admin/think_tank' %>

<div class="think-tank-dashboard">
  <div class="tt-header">
    <h1>ðŸ§  Episode Details</h1>
    <div class="tt-header-actions">
      <%= link_to 'â† Back to Dashboard', { action: 'index' }, class: 'button' %>
      <% if @episode.preview_url %>
        <%= link_to 'View Page â†—', @episode.preview_url, target: '_blank', class: 'button' %>
      <% end %>
    </div>
  </div>
  
  <!-- Episode Info -->
  <div class="tt-settings-section">
    <h2>Episode Information</h2>
    
    <table class="tt-info-table">
      <tr>
        <th>UUID</th>
        <td><code><%= @episode.uuid %></code></td>
      </tr>
      <tr>
        <th>Status</th>
        <td>
          <span class="tt-status tt-status-<%= @episode.status %>">
            <%= status_icon(@episode.status) %> <%= @episode.status.titleize %>
          </span>
        </td>
      </tr>
      <tr>
        <th>Goal</th>
        <td><%= @episode.goal %></td>
      </tr>
      <tr>
        <th>Model Used</th>
        <td><%= @episode.model_used || 'N/A' %></td>
      </tr>
      <tr>
        <th>Tokens Used</th>
        <td><%= format_tokens(@episode.tokens_used) %></td>
      </tr>
      <tr>
        <th>Estimated Cost</th>
        <td><%= format_cost(@episode.cost_estimate) %></td>
      </tr>
      <tr>
        <th>Duration</th>
        <td><%= format_duration(@episode.duration) %></td>
      </tr>
      <tr>
        <th>Created</th>
        <td><%= @episode.created_at.strftime('%Y-%m-%d %H:%M:%S') %></td>
      </tr>
      <% if @episode.completed_at %>
        <tr>
          <th>Completed</th>
          <td><%= @episode.completed_at.strftime('%Y-%m-%d %H:%M:%S') %></td>
        </tr>
      <% end %>
      <% if @episode.error_message %>
        <tr>
          <th>Error</th>
          <td class="tt-error-text"><%= @episode.error_message %></td>
        </tr>
      <% end %>
    </table>
  </div>
  
  <!-- Artifacts -->
  <% if @artifacts.any? %>
    <div class="tt-settings-section">
      <h2>Created Artifacts</h2>
      
      <table class="tt-artifacts-table">
        <thead>
          <tr>
            <th>Type</th>
            <th>ID</th>
            <th>Role</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <% @artifacts.each do |artifact| %>
            <tr>
              <td><%= artifact.artifactable_type %></td>
              <td><%= artifact.artifactable_id %></td>
              <td><%= artifact.role || 'N/A' %></td>
              <td>
                <% if artifact.exists? %>
                  <% case artifact.artifactable_type %>
                  <% when 'Page' %>
                    <%= link_to 'Edit', "/admin/pages/edit/#{artifact.artifactable_id}", class: 'tt-link' %>
                    <% if artifact.url %>
                      <%= link_to 'View', artifact.url, target: '_blank', class: 'tt-link' %>
                    <% end %>
                  <% when 'Snippet' %>
                    <%= link_to 'Edit', "/admin/snippets/edit/#{artifact.artifactable_id}", class: 'tt-link' %>
                  <% end %>
                <% else %>
                  <span class="tt-deleted">(Deleted)</span>
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  <% end %>
  
  <!-- Log Stream -->
  <div class="tt-settings-section">
    <h2>Build Log</h2>
    
    <div class="tt-terminal tt-terminal-readonly">
      <% if @episode.log_stream.present? %>
        <% @episode.log_stream.each do |log| %>
          <div class="tt-log tt-log-<%= log[:level] || log['level'] %>">
            <span class="tt-log-time"><%= log[:time] || log['time'] %></span>
            <span class="tt-log-msg"><%= log[:message] || log['message'] %></span>
          </div>
        <% end %>
      <% else %>
        <div class="tt-log tt-log-info">
          <span class="tt-log-time">--:--:--</span>
          <span class="tt-log-msg">No logs recorded</span>
        </div>
      <% end %>
    </div>
  </div>
  
  <!-- Actions -->
  <div class="tt-settings-section">
    <h2>Actions</h2>
    
    <div class="tt-form-actions-inline">
      <%= link_to 'Delete Episode', 
          { action: 'destroy', uuid: @episode.uuid },
          method: :delete,
          data: { confirm: 'Are you sure you want to delete this episode?' },
          class: 'tt-button tt-button-danger' %>
      
      <%= link_to 'Delete Episode + Artifacts', 
          { action: 'destroy', uuid: @episode.uuid, delete_artifacts: 'true' },
          method: :delete,
          data: { confirm: 'This will delete the episode AND all created Pages/Snippets. Are you sure?' },
          class: 'tt-button tt-button-danger' %>
    </div>
  </div>
</div>

<style>
.tt-info-table {
  width: 100%;
  border-collapse: collapse;
}

.tt-info-table th,
.tt-info-table td {
  padding: 10px 15px;
  text-align: left;
  border-bottom: 1px solid #e9ecef;
}

.tt-info-table th {
  width: 150px;
  color: #6c757d;
  font-weight: 500;
}

.tt-artifacts-table {
  width: 100%;
  border-collapse: collapse;
}

.tt-artifacts-table th,
.tt-artifacts-table td {
  padding: 10px 15px;
  text-align: left;
  border-bottom: 1px solid #e9ecef;
}

.tt-artifacts-table th {
  background: #f8f9fa;
  font-weight: 600;
}

.tt-deleted {
  color: #dc3545;
  font-style: italic;
}

.tt-error-text {
  color: #dc3545;
}

.tt-terminal-readonly {
  max-height: 400px;
  overflow-y: auto;
}

.tt-button-danger {
  background: #dc3545;
  color: white;
}

.tt-button-danger:hover {
  background: #c82333;
}
</style>
