#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Ensure PATH includes common package manager locations
export PATH="/opt/homebrew/bin:/usr/local/bin:$HOME/.local/share/pnpm:$HOME/.pnpm:$PATH"

# Run lint-staged (skip if pnpm not available)
if command -v pnpm >/dev/null 2>&1; then
  pnpm lint-staged
elif command -v npx >/dev/null 2>&1; then
  npx lint-staged
else
  echo "‚ö†Ô∏è  Neither pnpm nor npx found - skipping lint-staged"
fi

# Check for secrets
echo "üîç Checking for secrets..."
if git diff --cached --name-only | xargs grep -l -E "(AKIA[A-Z0-9]{16}|sk-[a-zA-Z0-9]{48}|password\s*=\s*['\"][^'\"]+['\"])" 2>/dev/null; then
  echo "‚ùå Potential secrets detected in staged files!"
  echo "Please remove secrets before committing."
  exit 1
fi

# Version bump enforcement (PROMPT-33 requirement)
if [ -z "$SKIP_VERSION_CHECK" ]; then
  CODE_CHANGED=$(git diff --cached --name-only | grep -E "^(packages/|apps/|migrations/)" | head -1)
  
  if [ -n "$CODE_CHANGED" ]; then
    VERSION_CHANGED=$(git diff --cached --name-only | grep -E "^(VERSION|RADIANT_VERSION|THINKTANK_VERSION)$" | head -1)
    
    if [ -z "$VERSION_CHANGED" ]; then
      echo "‚ö†Ô∏è  Code changes detected but no version bump found!"
      echo "   Changed: $CODE_CHANGED"
      echo ""
      echo "   Run: bash tools/scripts/bump-version.sh [patch|minor|major]"
      echo "   Or set SKIP_VERSION_CHECK=1 to bypass"
      exit 1
    fi
  fi
fi

# Run discrete validation
echo "üîç Running discrete validation..."
if [ -f "tools/scripts/validate-discrete.sh" ]; then
  bash tools/scripts/validate-discrete.sh || {
    echo "‚ùå Discrete validation failed"
    exit 1
  }
fi

echo "‚úÖ Pre-commit checks passed"
