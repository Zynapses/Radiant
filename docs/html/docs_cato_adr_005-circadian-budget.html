<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>005 circadian budget - RADIANT Documentation</title>
  
<style>
@media print {
  body { font-size: 11pt !important; }
  pre { page-break-inside: avoid; }
  h1, h2, h3 { page-break-after: avoid; }
  .no-print { display: none !important; }
}

* { box-sizing: border-box; }

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  line-height: 1.7;
  color: #1d1d1f;
  max-width: 900px;
  margin: 0 auto;
  padding: 40px 30px;
  background: white;
}

h1 {
  color: #1d1d1f;
  border-bottom: 3px solid #0071e3;
  padding-bottom: 12px;
  font-size: 28px;
  margin-top: 0;
}

h2 {
  color: #1d1d1f;
  border-bottom: 1px solid #d2d2d7;
  padding-bottom: 8px;
  font-size: 22px;
  margin-top: 40px;
}

h3 { color: #1d1d1f; font-size: 18px; margin-top: 30px; }
h4 { color: #1d1d1f; font-size: 16px; margin-top: 25px; }

a { color: #0071e3; text-decoration: none; }
a:hover { text-decoration: underline; }

code {
  background: #f5f5f7;
  padding: 2px 6px;
  border-radius: 4px;
  font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
  font-size: 0.9em;
  color: #1d1d1f;
}

pre {
  background: #1d1d1f;
  color: #f5f5f7;
  padding: 20px;
  border-radius: 10px;
  overflow-x: auto;
  font-size: 13px;
  line-height: 1.5;
}

pre code {
  background: transparent;
  padding: 0;
  color: inherit;
}

table {
  width: 100%;
  border-collapse: collapse;
  margin: 20px 0;
  font-size: 14px;
}

th, td {
  border: 1px solid #d2d2d7;
  padding: 12px 15px;
  text-align: left;
}

th {
  background: #0071e3;
  color: white;
  font-weight: 600;
}

tr:nth-child(even) { background: #f5f5f7; }

blockquote {
  border-left: 4px solid #0071e3;
  margin: 20px 0;
  padding: 15px 25px;
  background: #f5f5f7;
  border-radius: 0 8px 8px 0;
}

blockquote p { margin: 0; }

img { max-width: 100%; height: auto; border-radius: 8px; }

hr {
  border: none;
  border-top: 1px solid #d2d2d7;
  margin: 40px 0;
}

ul, ol { padding-left: 25px; }
li { margin: 8px 0; }

.header-bar {
  background: linear-gradient(135deg, #0071e3 0%, #00c6ff 100%);
  color: white;
  padding: 20px 30px;
  margin: -40px -30px 30px -30px;
  border-radius: 0 0 16px 16px;
}

.header-bar h1 {
  color: white;
  border: none;
  margin: 0;
  padding: 0;
}

.header-bar .meta {
  font-size: 13px;
  opacity: 0.9;
  margin-top: 8px;
}

.print-btn {
  position: fixed;
  top: 20px;
  right: 20px;
  background: #0071e3;
  color: white;
  border: none;
  padding: 12px 24px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
  box-shadow: 0 4px 12px rgba(0,113,227,0.3);
}

.print-btn:hover { background: #0077ed; }

.mermaid {
  background: #f5f5f7;
  padding: 20px;
  border-radius: 10px;
  text-align: center;
  margin: 20px 0;
}

.footer {
  margin-top: 60px;
  padding-top: 20px;
  border-top: 1px solid #d2d2d7;
  color: #86868b;
  font-size: 12px;
  text-align: center;
}
</style>

</head>
<body>
  <button class="print-btn no-print" onclick="window.print()">ğŸ–¨ï¸ Print / Save as PDF</button>
  
  <div class="header-bar">
    <h1>005 circadian budget</h1>
    <div class="meta">RADIANT v5.52.29 | docs/cato/adr/005-circadian-budget.md</div>
  </div>
  
  <h1 id="adr-005-circadian-budget-management">ADR-005: Circadian Budget Management</h1>
<h2 id="status">Status</h2>
<p>Accepted</p>
<h2 id="context">Context</h2>
<p>Catoâ€™s curiosity is designed to be autonomous and continuous. Without constraints, this creates a runaway cost problem:</p>
<h3 id="uncontrolled-curiosity-cost-model">Uncontrolled Curiosity Cost Model</h3>
<pre><code>Curiosity loop = 1 question + 1 answer + grounding
Average cost per loop = $0.01 (Haiku) to $0.10 (Sonnet with tools)

Continuous operation (24/7):
- 1 loop/second = 86,400 loops/day
- At $0.05 average = $4,320/day = $129,600/month

This exceeds the $500/month target by 260x!</code></pre>
<p>Additionally, running curiosity during peak user hours: 1. Competes for model capacity 2. Increases latency for user queries 3. Wastes money on real-time inference (vs.Â batch pricing)</p>
<h2 id="decision">Decision</h2>
<p>Implement a <strong>circadian rhythm</strong> for Cato with distinct day/night operational modes and hard budget caps.</p>
<h3 id="operating-modes">Operating Modes</h3>
<table>
<colgroup>
<col style="width: 16%" />
<col style="width: 35%" />
<col style="width: 27%" />
<col style="width: 21%" />
</colgroup>
<thead>
<tr>
<th>Mode</th>
<th>Hours (UTC)</th>
<th>Behavior</th>
<th>Budget</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>DAY</strong></td>
<td>6 AM - 2 AM</td>
<td>Queue curiosity, serve users</td>
<td>$0 exploration</td>
</tr>
<tr>
<td><strong>NIGHT</strong></td>
<td>2 AM - 6 AM</td>
<td>Batch process exploration</td>
<td>Up to $15/night</td>
</tr>
<tr>
<td><strong>EMERGENCY</strong></td>
<td>Any</td>
<td>Over budget, minimal ops</td>
<td>$0 all activity</td>
</tr>
</tbody>
</table>
<h3 id="budget-hierarchy">Budget Hierarchy</h3>
<pre><code>Monthly Budget: $500 (admin-configurable)
â”œâ”€â”€ User Interactions: $400 (80%)
â”‚   â”œâ”€â”€ Real-time inference
â”‚   â””â”€â”€ Cache misses
â””â”€â”€ Autonomous Exploration: $100 (20%)
    â”œâ”€â”€ Night-mode curiosity: $85
    â”œâ”€â”€ Tool grounding: $10
    â””â”€â”€ Memory consolidation: $5

Daily Exploration Cap: $15 (prevents single bad night)</code></pre>
<h3 id="night-mode-benefits">Night Mode Benefits</h3>
<ol type="1">
<li><strong>Bedrock Batch API</strong>: 50% discount on batch inference</li>
<li><strong>Lower traffic</strong>: Less competition for resources</li>
<li><strong>Consolidation</strong>: Natural time for memory consolidation</li>
<li><strong>Global timing</strong>: 2-6 AM UTC covers low-traffic worldwide</li>
</ol>
<h2 id="architecture">Architecture</h2>
<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Circadian Budget Manager                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚   Clock     â”‚â”€â”€â”€â–¶â”‚ Mode Decider â”‚â”€â”€â”€â–¶â”‚  Enforcer   â”‚         â”‚
â”‚  â”‚  (UTC)      â”‚    â”‚             â”‚    â”‚             â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                              â”‚                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚                   â”‚
â”‚  â”‚   Cost      â”‚â”€â”€â”€â–¶â”‚  Budget     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚  â”‚  Tracker    â”‚    â”‚  Checker    â”‚                             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â–¼                   â–¼                   â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ DAY MODE  â”‚       â”‚NIGHT MODE â”‚       â”‚ EMERGENCY â”‚
    â”‚           â”‚       â”‚           â”‚       â”‚           â”‚
    â”‚ Queue     â”‚       â”‚ Process   â”‚       â”‚ Serve     â”‚
    â”‚ curiosity â”‚       â”‚ queue     â”‚       â”‚ from      â”‚
    â”‚           â”‚       â”‚ (batch)   â”‚       â”‚ cache     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
<h2 id="implementation">Implementation</h2>
<h3 id="typescript-service">TypeScript Service</h3>
<pre class="typescript"><code>import { DynamoDBClient } from &#39;@aws-sdk/client-dynamodb&#39;;
import { DynamoDBDocumentClient, GetCommand, UpdateCommand } from &#39;@aws-sdk/lib-dynamodb&#39;;

export enum OperatingMode {
  DAY = &#39;day&#39;,
  NIGHT = &#39;night&#39;,
  EMERGENCY = &#39;emergency&#39;
}

export interface BudgetConfig {
  monthlyLimit: number;        // Default: $500
  dailyExplorationLimit: number; // Default: $15
  explorationRatio: number;    // Default: 0.20
  nightStartHour: number;      // Default: 2 (2 AM UTC)
  nightEndHour: number;        // Default: 6 (6 AM UTC)
  emergencyThreshold: number;  // Default: 0.90
}

export interface BudgetStatus {
  mode: OperatingMode;
  dailySpend: number;
  monthlySpend: number;
  dailyRemaining: number;
  monthlyRemaining: number;
  canExplore: boolean;
  nextModeChange: Date;
}

export class CircadianBudgetManager {
  private readonly docClient: DynamoDBDocumentClient;
  private readonly configTable: string;
  private readonly costsTable: string;
  private config: BudgetConfig | null = null;
  private lastConfigRefresh: Date | null = null;

  constructor(
    configTable: string = &#39;cato-config&#39;,
    costsTable: string = &#39;cato-costs&#39;,
    region: string = &#39;us-east-1&#39;
  ) {
    const client = new DynamoDBClient({ region });
    this.docClient = DynamoDBDocumentClient.from(client);
    this.configTable = configTable;
    this.costsTable = costsTable;
  }

  async getConfig(): Promise&lt;BudgetConfig&gt; {
    const now = new Date();
    
    // Refresh config every 5 minutes
    if (
      this.config === null ||
      this.lastConfigRefresh === null ||
      now.getTime() - this.lastConfigRefresh.getTime() &gt; 300000
    ) {
      const response = await this.docClient.send(new GetCommand({
        TableName: this.configTable,
        Key: { pk: &#39;CONFIG&#39;, sk: &#39;BUDGET&#39; }
      }));

      if (response.Item) {
        this.config = {
          monthlyLimit: response.Item.monthlyLimit ?? 500,
          dailyExplorationLimit: response.Item.dailyExplorationLimit ?? 15,
          explorationRatio: response.Item.explorationRatio ?? 0.20,
          nightStartHour: response.Item.nightStartHour ?? 2,
          nightEndHour: response.Item.nightEndHour ?? 6,
          emergencyThreshold: response.Item.emergencyThreshold ?? 0.90
        };
      } else {
        // Default config
        this.config = {
          monthlyLimit: 500,
          dailyExplorationLimit: 15,
          explorationRatio: 0.20,
          nightStartHour: 2,
          nightEndHour: 6,
          emergencyThreshold: 0.90
        };
      }

      this.lastConfigRefresh = now;
    }

    return this.config;
  }

  async getMode(): Promise&lt;OperatingMode&gt; {
    const config = await this.getConfig();
    const { dailySpend, monthlySpend } = await this.getSpendCounters();
    const now = new Date();
    const hour = now.getUTCHours();

    // Check emergency (budget exhausted)
    if (monthlySpend &gt;= config.monthlyLimit * config.emergencyThreshold) {
      return OperatingMode.EMERGENCY;
    }

    // Check daily exploration limit
    if (dailySpend &gt;= config.dailyExplorationLimit) {
      return OperatingMode.DAY; // No exploration but still serving
    }

    // Check time of day
    if (hour &gt;= config.nightStartHour &amp;&amp; hour &lt; config.nightEndHour) {
      return OperatingMode.NIGHT;
    }

    return OperatingMode.DAY;
  }

  async canExplore(): Promise&lt;boolean&gt; {
    const mode = await this.getMode();
    if (mode === OperatingMode.EMERGENCY) {
      return false;
    }

    const config = await this.getConfig();
    const { dailySpend } = await this.getSpendCounters();

    return dailySpend &lt; config.dailyExplorationLimit;
  }

  async recordCost(
    amount: number,
    category: &#39;inference&#39; | &#39;curiosity&#39; | &#39;grounding&#39; | &#39;consolidation&#39;,
    model: string,
    tokensInput: number = 0,
    tokensOutput: number = 0
  ): Promise&lt;void&gt; {
    const now = new Date();
    const month = now.toISOString().slice(0, 7); // YYYY-MM
    const day = now.toISOString().slice(0, 10);  // YYYY-MM-DD

    await this.docClient.send(new UpdateCommand({
      TableName: this.costsTable,
      Key: { pk: `COST#${month}`, sk: now.toISOString() },
      UpdateExpression: &#39;SET #amount = :amount, #category = :category, #model = :model, #day = :day, #tokensIn = :tokensIn, #tokensOut = :tokensOut&#39;,
      ExpressionAttributeNames: {
        &#39;#amount&#39;: &#39;amount&#39;,
        &#39;#category&#39;: &#39;category&#39;,
        &#39;#model&#39;: &#39;model&#39;,
        &#39;#day&#39;: &#39;day&#39;,
        &#39;#tokensIn&#39;: &#39;tokensInput&#39;,
        &#39;#tokensOut&#39;: &#39;tokensOutput&#39;
      },
      ExpressionAttributeValues: {
        &#39;:amount&#39;: amount,
        &#39;:category&#39;: category,
        &#39;:model&#39;: model,
        &#39;:day&#39;: day,
        &#39;:tokensIn&#39;: tokensInput,
        &#39;:tokensOut&#39;: tokensOutput
      }
    }));
  }

  async getStatus(): Promise&lt;BudgetStatus&gt; {
    const config = await this.getConfig();
    const mode = await this.getMode();
    const { dailySpend, monthlySpend } = await this.getSpendCounters();
    const canExplore = await this.canExplore();

    // Calculate next mode change
    const now = new Date();
    const hour = now.getUTCHours();
    let nextModeChange: Date;

    if (hour &lt; config.nightStartHour) {
      nextModeChange = new Date(now);
      nextModeChange.setUTCHours(config.nightStartHour, 0, 0, 0);
    } else if (hour &lt; config.nightEndHour) {
      nextModeChange = new Date(now);
      nextModeChange.setUTCHours(config.nightEndHour, 0, 0, 0);
    } else {
      nextModeChange = new Date(now);
      nextModeChange.setUTCDate(nextModeChange.getUTCDate() + 1);
      nextModeChange.setUTCHours(config.nightStartHour, 0, 0, 0);
    }

    return {
      mode,
      dailySpend,
      monthlySpend,
      dailyRemaining: Math.max(0, config.dailyExplorationLimit - dailySpend),
      monthlyRemaining: Math.max(0, config.monthlyLimit - monthlySpend),
      canExplore,
      nextModeChange
    };
  }

  private async getSpendCounters(): Promise&lt;{ dailySpend: number; monthlySpend: number }&gt; {
    // Implementation queries DynamoDB for current spend
    // Aggregates by day and month
    return { dailySpend: 0, monthlySpend: 0 }; // Placeholder
  }
}</code></pre>
<h2 id="consequences">Consequences</h2>
<h3 id="positive">Positive</h3>
<ul>
<li><strong>Predictable costs</strong>: Hard caps prevent budget overrun</li>
<li><strong>Optimal pricing</strong>: Night-mode uses Bedrock batch (50% off)</li>
<li><strong>User priority</strong>: Day mode focuses on user interactions</li>
<li><strong>Natural rhythm</strong>: Consolidation aligns with low-traffic periods</li>
</ul>
<h3 id="negative">Negative</h3>
<ul>
<li><strong>Delayed learning</strong>: Curiosity queued until night</li>
<li><strong>Global timing</strong>: 2-6 AM UTC may not suit all regions</li>
<li><strong>Complexity</strong>: Two operational modes to manage</li>
<li><strong>Queue management</strong>: Must handle curiosity queue</li>
</ul>
<h2 id="admin-configuration">Admin Configuration</h2>
<p>The budget manager is admin-configurable via the Radiant Admin dashboard:</p>
<table>
<thead>
<tr>
<th>Setting</th>
<th>Default</th>
<th>Range</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Monthly Limit</td>
<td>$500</td>
<td>$100-$10,000</td>
<td>Total monthly budget</td>
</tr>
<tr>
<td>Daily Exploration</td>
<td>$15</td>
<td>$5-$100</td>
<td>Max daily curiosity spend</td>
</tr>
<tr>
<td>Night Start</td>
<td>2 AM</td>
<td>0-23</td>
<td>When night mode begins (UTC)</td>
</tr>
<tr>
<td>Night End</td>
<td>6 AM</td>
<td>0-23</td>
<td>When night mode ends (UTC)</td>
</tr>
<tr>
<td>Emergency Threshold</td>
<td>90%</td>
<td>50-99%</td>
<td>When to enter emergency mode</td>
</tr>
</tbody>
</table>
<h2 id="scaling-budget-with-users">Scaling Budget with Users</h2>
<p>As user base grows, budget should scale:</p>
<table>
<thead>
<tr>
<th>Users</th>
<th>Monthly Budget</th>
<th>Daily Exploration</th>
<th>Rationale</th>
</tr>
</thead>
<tbody>
<tr>
<td>0-10K</td>
<td>$500</td>
<td>$15</td>
<td>Starting budget</td>
</tr>
<tr>
<td>10K-100K</td>
<td>$2,000</td>
<td>$60</td>
<td>4x growth</td>
</tr>
<tr>
<td>100K-1M</td>
<td>$10,000</td>
<td>$300</td>
<td>Supporting infrastructure</td>
</tr>
<tr>
<td>1M-10M</td>
<td>$100,000</td>
<td>$3,000</td>
<td>At scale</td>
</tr>
</tbody>
</table>
<h2 id="references">References</h2>
<ul>
<li><a href="https://docs.aws.amazon.com/bedrock/latest/userguide/batch-inference.html">AWS Bedrock Batch Inference</a></li>
<li><a href="https://arxiv.org/abs/2303.08774">Circadian Rhythms in AI Systems</a></li>
<li><a href="https://aws.amazon.com/blogs/machine-learning/optimizing-costs-for-machine-learning-with-amazon-sagemaker/">Cost Optimization for ML Workloads</a></li>
</ul>

  
  <div class="footer">
    RADIANT Documentation | Version 5.52.29 | Generated January 25, 2026
  </div>
</body>
</html>