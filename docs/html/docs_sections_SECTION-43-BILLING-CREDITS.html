<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SECTION 43 BILLING CREDITS - RADIANT Documentation</title>
  
<style>
@media print {
  body { font-size: 11pt !important; }
  pre { page-break-inside: avoid; }
  h1, h2, h3 { page-break-after: avoid; }
  .no-print { display: none !important; }
}

* { box-sizing: border-box; }

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  line-height: 1.7;
  color: #1d1d1f;
  max-width: 900px;
  margin: 0 auto;
  padding: 40px 30px;
  background: white;
}

h1 {
  color: #1d1d1f;
  border-bottom: 3px solid #0071e3;
  padding-bottom: 12px;
  font-size: 28px;
  margin-top: 0;
}

h2 {
  color: #1d1d1f;
  border-bottom: 1px solid #d2d2d7;
  padding-bottom: 8px;
  font-size: 22px;
  margin-top: 40px;
}

h3 { color: #1d1d1f; font-size: 18px; margin-top: 30px; }
h4 { color: #1d1d1f; font-size: 16px; margin-top: 25px; }

a { color: #0071e3; text-decoration: none; }
a:hover { text-decoration: underline; }

code {
  background: #f5f5f7;
  padding: 2px 6px;
  border-radius: 4px;
  font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
  font-size: 0.9em;
  color: #1d1d1f;
}

pre {
  background: #1d1d1f;
  color: #f5f5f7;
  padding: 20px;
  border-radius: 10px;
  overflow-x: auto;
  font-size: 13px;
  line-height: 1.5;
}

pre code {
  background: transparent;
  padding: 0;
  color: inherit;
}

table {
  width: 100%;
  border-collapse: collapse;
  margin: 20px 0;
  font-size: 14px;
}

th, td {
  border: 1px solid #d2d2d7;
  padding: 12px 15px;
  text-align: left;
}

th {
  background: #0071e3;
  color: white;
  font-weight: 600;
}

tr:nth-child(even) { background: #f5f5f7; }

blockquote {
  border-left: 4px solid #0071e3;
  margin: 20px 0;
  padding: 15px 25px;
  background: #f5f5f7;
  border-radius: 0 8px 8px 0;
}

blockquote p { margin: 0; }

img { max-width: 100%; height: auto; border-radius: 8px; }

hr {
  border: none;
  border-top: 1px solid #d2d2d7;
  margin: 40px 0;
}

ul, ol { padding-left: 25px; }
li { margin: 8px 0; }

.header-bar {
  background: linear-gradient(135deg, #0071e3 0%, #00c6ff 100%);
  color: white;
  padding: 20px 30px;
  margin: -40px -30px 30px -30px;
  border-radius: 0 0 16px 16px;
}

.header-bar h1 {
  color: white;
  border: none;
  margin: 0;
  padding: 0;
}

.header-bar .meta {
  font-size: 13px;
  opacity: 0.9;
  margin-top: 8px;
}

.print-btn {
  position: fixed;
  top: 20px;
  right: 20px;
  background: #0071e3;
  color: white;
  border: none;
  padding: 12px 24px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
  box-shadow: 0 4px 12px rgba(0,113,227,0.3);
}

.print-btn:hover { background: #0077ed; }

.mermaid {
  background: #f5f5f7;
  padding: 20px;
  border-radius: 10px;
  text-align: center;
  margin: 20px 0;
}

.footer {
  margin-top: 60px;
  padding-top: 20px;
  border-top: 1px solid #d2d2d7;
  color: #86868b;
  font-size: 12px;
  text-align: center;
}
</style>

</head>
<body>
  <button class="print-btn no-print" onclick="window.print()">ğŸ–¨ï¸ Print / Save as PDF</button>
  
  <div class="header-bar">
    <h1>SECTION 43 BILLING CREDITS</h1>
    <div class="meta">RADIANT v5.52.29 | docs/sections/SECTION-43-BILLING-CREDITS.md</div>
  </div>
  
  <h1 id="section-43-billing-credits-system-v4.13.0">SECTION 43: BILLING &amp; CREDITS SYSTEM (v4.13.0)</h1>
<h1 id="section">â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</h1>
<blockquote>
<p><strong>Version: 4.13.0 | Adds 7-tier subscriptions and prepaid credits system</strong></p>
</blockquote>
<hr />
<h2 id="billing-system-overview">43.1 BILLING SYSTEM OVERVIEW</h2>
<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     RADIANT v4.13.0 - BILLING SYSTEM                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚   â”‚     7-TIER SUBSCRIPTION MODEL           â”‚                                   â”‚
â”‚   â”‚     (Similar to OpenAI/ChatGPT)         â”‚                                   â”‚
â”‚   â”‚                                          â”‚                                   â”‚
â”‚   â”‚  â€¢ FREE - Trial ($0, 0.5 credits)       â”‚                                   â”‚
â”‚   â”‚  â€¢ INDIVIDUAL - Personal ($29/mo)       â”‚                                   â”‚
â”‚   â”‚  â€¢ FAMILY - Household ($49/mo, 5 users) â”‚                                   â”‚
â”‚   â”‚  â€¢ TEAM - Small biz ($25/user, 2-25)    â”‚                                   â”‚
â”‚   â”‚  â€¢ BUSINESS - Mid-market ($45/user)     â”‚                                   â”‚
â”‚   â”‚  â€¢ ENTERPRISE - Large orgs (Custom)     â”‚                                   â”‚
â”‚   â”‚  â€¢ ENTERPRISE PLUS - Compliance incl.   â”‚                                   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
â”‚                                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚   â”‚     PREPAID CREDITS SYSTEM              â”‚                                   â”‚
â”‚   â”‚     (Similar to Windsurf Pro)           â”‚                                   â”‚
â”‚   â”‚                                          â”‚                                   â”‚
â”‚   â”‚  â€¢ $10 = 1 Credit (any quantity)        â”‚                                   â”‚
â”‚   â”‚  â€¢ Volume discounts (5% to 25% off)     â”‚                                   â”‚
â”‚   â”‚  â€¢ Bonus credits for bulk purchases     â”‚                                   â”‚
â”‚   â”‚  â€¢ Credit pools for families/teams      â”‚                                   â”‚
â”‚   â”‚  â€¢ Auto-purchase when balance low       â”‚                                   â”‚
â”‚   â”‚  â€¢ Credits never expire                 â”‚                                   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
â”‚                                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚   â”‚     COMPLIANCE ADD-ON ($25/user/mo)     â”‚                                   â”‚
â”‚   â”‚     Available for TEAM+ tiers           â”‚                                   â”‚
â”‚   â”‚                                          â”‚                                   â”‚
â”‚   â”‚  â€¢ HIPAA + BAA                          â”‚                                   â”‚
â”‚   â”‚  â€¢ SOC 2 Type II                        â”‚                                   â”‚
â”‚   â”‚  â€¢ GDPR/CCPA compliance                 â”‚                                   â”‚
â”‚   â”‚  â€¢ Customer-managed encryption keys     â”‚                                   â”‚
â”‚   â”‚  â€¢ Enhanced audit logging               â”‚                                   â”‚
â”‚   â”‚  â€¢ Data residency options               â”‚                                   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
<hr />
<h2 id="subscription-tiers">43.2 SUBSCRIPTION TIERS</h2>
<h3 id="packagessharedsrcbillingtiers.ts">packages/shared/src/billing/tiers.ts</h3>
<pre class="typescript"><code>/**
 * RADIANT Subscription Tiers
 * 7-tier model from FREE to ENTERPRISE PLUS
 * 
 * @version 4.13.0
 * @module @radiant/shared/billing
 */

// ============================================================================
// TIER DEFINITIONS
// ============================================================================

export type SubscriptionTierId = 
  | &#39;FREE&#39;
  | &#39;INDIVIDUAL&#39;
  | &#39;FAMILY&#39;
  | &#39;TEAM&#39;
  | &#39;BUSINESS&#39;
  | &#39;ENTERPRISE&#39;
  | &#39;ENTERPRISE_PLUS&#39;;

export interface SubscriptionTier {
  id: SubscriptionTierId;
  displayName: string;  // Fallback - use localizationKey at runtime
  description: string;  // Fallback - use localizationKey at runtime
  localizationKey: string;  // e.g., &#39;billing.tiers.free&#39; for i18n lookup
  
  // Pricing
  pricing: {
    monthly: number | null;           // null = contact sales
    annual: number | null;
    perUser: boolean;
    minUsers?: number;
    maxUsers?: number;
    currency: string;
    contactSales?: boolean;
  };
  
  // Credits
  includedCreditsPerUser: number;     // Monthly credits per user/seat
  
  // Rate limits
  rateLimits: {
    requestsPerMinute: number;
    tokensPerMinute: number;
    concurrentRequests: number;
  };
  
  // Features
  features: TierFeatures;
  
  // Add-ons available
  availableAddOns: string[];
  
  // Display
  isPublic: boolean;
  sortOrder: number;
  badge?: string;
}

export interface TierFeatures {
  modelAccess: &#39;limited&#39; | &#39;full&#39; | &#39;full_plus_beta&#39; | &#39;all&#39;;
  maxModelsPerMonth: number | null;
  maxRequestsPerDay: number | null;
  maxTokensPerRequest: number;
  priorityQueue: boolean;
  apiAccess: boolean;
  exportFormats: string[];
  supportLevel: &#39;community&#39; | &#39;email&#39; | &#39;priority_email&#39; | &#39;priority&#39; | &#39;dedicated&#39;;
  dataRetention: string;
  watermarkedOutputs: boolean;
  conversationHistory: boolean;
  customInstructions: boolean;
  
  // Sharing features
  sharedCreditPool: boolean;
  teamWorkspaces: boolean;
  sharedConversations: boolean;
  
  // Admin features
  teamAdminDashboard: boolean;
  usageAnalytics: boolean;
  roleBasedAccess: boolean;
  inviteManagement: boolean;
  
  // Enterprise features
  ssoIntegration: boolean;
  scimProvisioning: boolean;
  auditLogs: boolean;
  dataExport: boolean;
  customBranding: boolean;
  dedicatedAccountManager: boolean;
  apiRateLimitCustomization: boolean;
  webhooks: boolean;
  ipWhitelisting: boolean;
  
  // Family features
  parentalControls?: boolean;
  familyAdminDashboard?: boolean;
  perMemberUsageLimits?: boolean;
  
  // Enterprise Plus features
  slaGuarantee?: boolean;
  uptimeGuarantee?: string;
  customModelFineTuning?: boolean;
  dedicatedInfrastructure?: boolean;
  multiRegionDeployment?: boolean;
  onPremiseDeployment?: boolean;
}

// ============================================================================
// TIER REGISTRY
// ============================================================================

export const SUBSCRIPTION_TIERS: Record&lt;SubscriptionTierId, SubscriptionTier&gt; = {
  FREE: {
    id: &#39;FREE&#39;,
    displayName: &#39;Free Trial&#39;,  // Fallback
    description: &#39;Try RADIANT with limited features&#39;,  // Fallback
    localizationKey: &#39;billing.tiers.free&#39;,
    pricing: { monthly: 0, annual: 0, perUser: false, currency: &#39;USD&#39; },
    includedCreditsPerUser: 0.5,
    rateLimits: { requestsPerMinute: 10, tokensPerMinute: 20_000, concurrentRequests: 1 },
    features: {
      modelAccess: &#39;limited&#39;, maxModelsPerMonth: 5, maxRequestsPerDay: 50,
      maxTokensPerRequest: 4_000, priorityQueue: false, apiAccess: false,
      exportFormats: [&#39;txt&#39;], supportLevel: &#39;community&#39;, dataRetention: &#39;7_days&#39;,
      watermarkedOutputs: true, conversationHistory: false, customInstructions: false,
      sharedCreditPool: false, teamWorkspaces: false, sharedConversations: false,
      teamAdminDashboard: false, usageAnalytics: false, roleBasedAccess: false,
      inviteManagement: false, ssoIntegration: false, scimProvisioning: false,
      auditLogs: false, dataExport: false, customBranding: false,
      dedicatedAccountManager: false, apiRateLimitCustomization: false,
      webhooks: false, ipWhitelisting: false,
    },
    availableAddOns: [],
    isPublic: true,
    sortOrder: 0,
  },
  
  INDIVIDUAL: {
    id: &#39;INDIVIDUAL&#39;,
    displayName: &#39;Individual&#39;,  // Fallback
    description: &#39;Full-featured personal plan&#39;,  // Fallback
    localizationKey: &#39;billing.tiers.individual&#39;,
    pricing: { monthly: 29, annual: 290, perUser: false, currency: &#39;USD&#39; },
    includedCreditsPerUser: 3,
    rateLimits: { requestsPerMinute: 60, tokensPerMinute: 100_000, concurrentRequests: 5 },
    features: {
      modelAccess: &#39;full&#39;, maxModelsPerMonth: null, maxRequestsPerDay: 1_000,
      maxTokensPerRequest: 128_000, priorityQueue: true, apiAccess: true,
      exportFormats: [&#39;txt&#39;, &#39;md&#39;, &#39;pdf&#39;, &#39;docx&#39;], supportLevel: &#39;email&#39;,
      dataRetention: &#39;90_days&#39;, watermarkedOutputs: false, conversationHistory: true,
      customInstructions: true, sharedCreditPool: false, teamWorkspaces: false,
      sharedConversations: false, teamAdminDashboard: false, usageAnalytics: false,
      roleBasedAccess: false, inviteManagement: false, ssoIntegration: false,
      scimProvisioning: false, auditLogs: false, dataExport: false,
      customBranding: false, dedicatedAccountManager: false,
      apiRateLimitCustomization: false, webhooks: false, ipWhitelisting: false,
    },
    availableAddOns: [&#39;API_POWER_PACK&#39;],
    isPublic: true,
    sortOrder: 1,
  },
  
  FAMILY: {
    id: &#39;FAMILY&#39;,
    displayName: &#39;Family&#39;,  // Fallback
    description: &#39;Share AI across your household&#39;,  // Fallback
    localizationKey: &#39;billing.tiers.family&#39;,
    id: &#39;FAMILY&#39;,
    displayName: &#39;Family&#39;,
    description: &#39;Share AI across your household&#39;,
    pricing: { monthly: 49, annual: 490, perUser: false, maxUsers: 5, currency: &#39;USD&#39; },
    includedCreditsPerUser: 6,
    rateLimits: { requestsPerMinute: 120, tokensPerMinute: 200_000, concurrentRequests: 10 },
    features: {
      modelAccess: &#39;full&#39;, maxModelsPerMonth: null, maxRequestsPerDay: 2_000,
      maxTokensPerRequest: 128_000, priorityQueue: true, apiAccess: true,
      exportFormats: [&#39;txt&#39;, &#39;md&#39;, &#39;pdf&#39;, &#39;docx&#39;], supportLevel: &#39;email&#39;,
      dataRetention: &#39;90_days&#39;, watermarkedOutputs: false, conversationHistory: true,
      customInstructions: true, sharedCreditPool: true, teamWorkspaces: false,
      sharedConversations: false, teamAdminDashboard: false, usageAnalytics: false,
      roleBasedAccess: false, inviteManagement: true, ssoIntegration: false,
      scimProvisioning: false, auditLogs: false, dataExport: false,
      customBranding: false, dedicatedAccountManager: false,
      apiRateLimitCustomization: false, webhooks: false, ipWhitelisting: false,
      parentalControls: true, familyAdminDashboard: true, perMemberUsageLimits: true,
    },
    availableAddOns: [&#39;API_POWER_PACK&#39;],
    isPublic: true,
    sortOrder: 2,
  },
  
  TEAM: {
    id: &#39;TEAM&#39;,
    displayName: &#39;Team&#39;,
    description: &#39;Collaborate with your small team&#39;,
    pricing: { monthly: 25, annual: 250, perUser: true, minUsers: 2, maxUsers: 25, currency: &#39;USD&#39; },
    includedCreditsPerUser: 3,
    rateLimits: { requestsPerMinute: 300, tokensPerMinute: 500_000, concurrentRequests: 20 },
    features: {
      modelAccess: &#39;full&#39;, maxModelsPerMonth: null, maxRequestsPerDay: null,
      maxTokensPerRequest: 200_000, priorityQueue: true, apiAccess: true,
      exportFormats: [&#39;txt&#39;, &#39;md&#39;, &#39;pdf&#39;, &#39;docx&#39;, &#39;html&#39;], supportLevel: &#39;priority_email&#39;,
      dataRetention: &#39;1_year&#39;, watermarkedOutputs: false, conversationHistory: true,
      customInstructions: true, sharedCreditPool: true, teamWorkspaces: true,
      sharedConversations: true, teamAdminDashboard: true, usageAnalytics: true,
      roleBasedAccess: true, inviteManagement: true, ssoIntegration: false,
      scimProvisioning: false, auditLogs: false, dataExport: false,
      customBranding: false, dedicatedAccountManager: false,
      apiRateLimitCustomization: false, webhooks: false, ipWhitelisting: false,
    },
    availableAddOns: [&#39;COMPLIANCE_ADDON&#39;, &#39;PRIORITY_SUPPORT&#39;],
    isPublic: true,
    sortOrder: 3,
    badge: &#39;Most Popular&#39;,
  },
  
  BUSINESS: {
    id: &#39;BUSINESS&#39;,
    displayName: &#39;Business&#39;,
    description: &#39;Enterprise features for growing companies&#39;,
    pricing: { monthly: 45, annual: 450, perUser: true, minUsers: 5, maxUsers: 150, currency: &#39;USD&#39; },
    includedCreditsPerUser: 5,
    rateLimits: { requestsPerMinute: 1_000, tokensPerMinute: 2_000_000, concurrentRequests: 50 },
    features: {
      modelAccess: &#39;full_plus_beta&#39;, maxModelsPerMonth: null, maxRequestsPerDay: null,
      maxTokensPerRequest: 500_000, priorityQueue: true, apiAccess: true,
      exportFormats: [&#39;txt&#39;, &#39;md&#39;, &#39;pdf&#39;, &#39;docx&#39;, &#39;html&#39;, &#39;json&#39;], supportLevel: &#39;priority&#39;,
      dataRetention: &#39;2_years&#39;, watermarkedOutputs: false, conversationHistory: true,
      customInstructions: true, sharedCreditPool: true, teamWorkspaces: true,
      sharedConversations: true, teamAdminDashboard: true, usageAnalytics: true,
      roleBasedAccess: true, inviteManagement: true, ssoIntegration: true,
      scimProvisioning: true, auditLogs: true, dataExport: true,
      customBranding: true, dedicatedAccountManager: false,
      apiRateLimitCustomization: true, webhooks: true, ipWhitelisting: true,
    },
    availableAddOns: [&#39;COMPLIANCE_ADDON&#39;, &#39;PRIORITY_SUPPORT&#39;],
    isPublic: true,
    sortOrder: 4,
  },
  
  ENTERPRISE: {
    id: &#39;ENTERPRISE&#39;,
    displayName: &#39;Enterprise&#39;,
    description: &#39;Full-scale enterprise deployment&#39;,
    pricing: { monthly: null, annual: null, perUser: true, minUsers: 50, currency: &#39;USD&#39;, contactSales: true },
    includedCreditsPerUser: 10,
    rateLimits: { requestsPerMinute: 5_000, tokensPerMinute: 10_000_000, concurrentRequests: 200 },
    features: {
      modelAccess: &#39;all&#39;, maxModelsPerMonth: null, maxRequestsPerDay: null,
      maxTokensPerRequest: 1_000_000, priorityQueue: true, apiAccess: true,
      exportFormats: [&#39;txt&#39;, &#39;md&#39;, &#39;pdf&#39;, &#39;docx&#39;, &#39;html&#39;, &#39;json&#39;, &#39;csv&#39;],
      supportLevel: &#39;dedicated&#39;, dataRetention: &#39;custom&#39;, watermarkedOutputs: false,
      conversationHistory: true, customInstructions: true, sharedCreditPool: true,
      teamWorkspaces: true, sharedConversations: true, teamAdminDashboard: true,
      usageAnalytics: true, roleBasedAccess: true, inviteManagement: true,
      ssoIntegration: true, scimProvisioning: true, auditLogs: true, dataExport: true,
      customBranding: true, dedicatedAccountManager: true,
      apiRateLimitCustomization: true, webhooks: true, ipWhitelisting: true,
      slaGuarantee: true, uptimeGuarantee: &#39;99.9%&#39;, customModelFineTuning: true,
      multiRegionDeployment: true,
    },
    availableAddOns: [&#39;COMPLIANCE_ADDON&#39;],
    isPublic: true,
    sortOrder: 5,
  },
  
  ENTERPRISE_PLUS: {
    id: &#39;ENTERPRISE_PLUS&#39;,
    displayName: &#39;Enterprise Plus&#39;,
    description: &#39;Maximum security and compliance for regulated industries&#39;,
    pricing: { monthly: null, annual: null, perUser: true, minUsers: 100, currency: &#39;USD&#39;, contactSales: true },
    includedCreditsPerUser: 15,
    rateLimits: { requestsPerMinute: 20_000, tokensPerMinute: 50_000_000, concurrentRequests: -1 },
    features: {
      modelAccess: &#39;all&#39;, maxModelsPerMonth: null, maxRequestsPerDay: null,
      maxTokensPerRequest: 2_000_000, priorityQueue: true, apiAccess: true,
      exportFormats: [&#39;txt&#39;, &#39;md&#39;, &#39;pdf&#39;, &#39;docx&#39;, &#39;html&#39;, &#39;json&#39;, &#39;csv&#39;, &#39;xml&#39;],
      supportLevel: &#39;dedicated&#39;, dataRetention: &#39;custom&#39;, watermarkedOutputs: false,
      conversationHistory: true, customInstructions: true, sharedCreditPool: true,
      teamWorkspaces: true, sharedConversations: true, teamAdminDashboard: true,
      usageAnalytics: true, roleBasedAccess: true, inviteManagement: true,
      ssoIntegration: true, scimProvisioning: true, auditLogs: true, dataExport: true,
      customBranding: true, dedicatedAccountManager: true,
      apiRateLimitCustomization: true, webhooks: true, ipWhitelisting: true,
      slaGuarantee: true, uptimeGuarantee: &#39;99.99%&#39;, customModelFineTuning: true,
      dedicatedInfrastructure: true, multiRegionDeployment: true, onPremiseDeployment: true,
    },
    availableAddOns: [], // Compliance included
    isPublic: true,
    sortOrder: 6,
    badge: &#39;Full Compliance Included&#39;,
  },
};

// ============================================================================
// HELPER FUNCTIONS
// ============================================================================

export function getTier(tierId: SubscriptionTierId): SubscriptionTier {
  return SUBSCRIPTION_TIERS[tierId];
}

export function canUpgrade(fromTier: SubscriptionTierId, toTier: SubscriptionTierId): boolean {
  return SUBSCRIPTION_TIERS[toTier].sortOrder &gt; SUBSCRIPTION_TIERS[fromTier].sortOrder;
}

export function getAnnualSavings(tier: SubscriptionTier): number {
  if (!tier.pricing.monthly || !tier.pricing.annual) return 0;
  return (tier.pricing.monthly * 12) - tier.pricing.annual;
}</code></pre>
<hr />
<h2 id="credits-system">43.3 CREDITS SYSTEM</h2>
<h3 id="packagessharedsrcbillingcredits.ts">packages/shared/src/billing/credits.ts</h3>
<pre class="typescript"><code>/**
 * RADIANT Credits System
 * Prepaid AI usage currency
 * 
 * @version 4.13.0
 * @module @radiant/shared/billing
 */

// ============================================================================
// CREDIT TYPES
// ============================================================================

export interface CreditPool {
  id: string;
  type: CreditPoolType;
  ownerId: string;
  organizationId?: string;
  tenantId: string;
  
  balance: {
    available: number;
    reserved: number;
    total: number;
  };
  
  monthlyIncluded: {
    total: number;
    used: number;
    remaining: number;
    resetsAt: string;
  };
  
  purchased: {
    total: number;
    remaining: number;
    lastPurchaseAt?: string;
  };
  
  bonus: {
    total: number;
    remaining: number;
  };
  
  members: CreditPoolMember[];
  settings: CreditPoolSettings;
  
  createdAt: string;
  updatedAt: string;
}

export type CreditPoolType = &#39;individual&#39; | &#39;family&#39; | &#39;team&#39; | &#39;organization&#39; | &#39;enterprise&#39;;

export interface CreditPoolMember {
  userId: string;
  email: string;
  displayName: string;
  role: &#39;owner&#39; | &#39;admin&#39; | &#39;member&#39; | &#39;restricted&#39;;
  
  limits?: {
    dailyCredits?: number;
    monthlyCredits?: number;
    maxCostPerRequest?: number;
  };
  
  permissions: CreditPoolPermissions;
  status: &#39;active&#39; | &#39;invited&#39; | &#39;suspended&#39;;
  joinedAt: string;
  lastActiveAt?: string;
  
  usage: {
    today: number;
    thisWeek: number;
    thisMonth: number;
    allTime: number;
  };
}

export interface CreditPoolPermissions {
  canPurchaseCredits: boolean;
  canViewPoolBalance: boolean;
  canViewOtherUsage: boolean;
  canInviteMembers: boolean;
  canRemoveMembers: boolean;
  canModifySettings: boolean;
}

export interface CreditPoolSettings {
  autoPurchase: {
    enabled: boolean;
    thresholdCredits: number;
    purchaseAmount: number;
    maxMonthlyAutoPurchase?: number;
    paymentMethodId?: string;
  };
  
  notifications: {
    lowBalanceThreshold: number;
    lowBalanceRecipients: string[];
    usageSummaryFrequency: &#39;daily&#39; | &#39;weekly&#39; | &#39;monthly&#39;;
    unusualUsageAlerts: boolean;
  };
  
  accessControl: {
    requireApprovalAbove?: number;
    blockedModels?: string[];
    allowedModels?: string[];
  };
  
  familySettings?: {
    parentalControlsEnabled: boolean;
    contentFiltering: &#39;strict&#39; | &#39;moderate&#39; | &#39;off&#39;;
    underageMembers: string[];
  };
}

// ============================================================================
// CREDIT TRANSACTIONS
// ============================================================================

export type CreditTransactionType = 
  | &#39;purchase&#39; | &#39;subscription_grant&#39; | &#39;bonus_grant&#39; | &#39;consumption&#39;
  | &#39;refund&#39; | &#39;adjustment&#39; | &#39;transfer_in&#39; | &#39;transfer_out&#39; | &#39;expiration&#39;;

export interface CreditTransaction {
  id: string;
  poolId: string;
  userId?: string;
  transactionType: CreditTransactionType;
  
  amount: number;
  balanceAfter: number;
  
  sourceType?: &#39;included&#39; | &#39;purchased&#39; | &#39;bonus&#39;;
  sourceId?: string;
  
  modelId?: string;
  requestId?: string;
  inputTokens?: number;
  outputTokens?: number;
  
  paymentIntentId?: string;
  paymentAmountCents?: number;
  paymentCurrency?: string;
  
  description?: string;
  metadata?: Record&lt;string, any&gt;;
  
  createdAt: string;
}

// ============================================================================
// CREDIT PRICING
// ============================================================================

export const CREDIT_PRICING = {
  basePrice: 10.00, // $10 = 1 Credit
  
  volumeDiscounts: [
    { minCredits: 1, discount: 0, bonus: 0 },
    { minCredits: 5, discount: 0, bonus: 0 },
    { minCredits: 10, discount: 0.05, bonus: 0.05 },   // 5% off, 5% bonus
    { minCredits: 25, discount: 0.10, bonus: 0.10 },   // 10% off, 10% bonus
    { minCredits: 50, discount: 0.15, bonus: 0.15 },   // 15% off, 15% bonus
    { minCredits: 100, discount: 0.20, bonus: 0.20 },  // 20% off, 20% bonus
  ],
  
  consumption: {
    text: {
      inputTokensPer1Credit: 1_000_000,
      outputTokensPer1Credit: 250_000,
    },
    image: {
      standardGenerationCredits: 0.02,
      hdGenerationCredits: 0.04,
    },
    audio: {
      transcriptionMinuteCredits: 0.01,
      ttsCharacterCredits: 0.00001,
    },
  },
};

export function calculatePurchasePrice(credits: number): {
  basePrice: number;
  discount: number;
  bonusCredits: number;
  finalPrice: number;
  totalCredits: number;
} {
  const tier = [...CREDIT_PRICING.volumeDiscounts]
    .reverse()
    .find(t =&gt; credits &gt;= t.minCredits) || CREDIT_PRICING.volumeDiscounts[0];
  
  const basePrice = credits * CREDIT_PRICING.basePrice;
  const discount = basePrice * tier.discount;
  const bonusCredits = credits * tier.bonus;
  
  return {
    basePrice,
    discount,
    bonusCredits,
    finalPrice: basePrice - discount,
    totalCredits: credits + bonusCredits,
  };
}</code></pre>
<hr />
<h2 id="database-schema">43.4 DATABASE SCHEMA</h2>
<h3 id="packagesinfrastructuremigrations043_billing_system.sql">packages/infrastructure/migrations/043_billing_system.sql</h3>
<pre class="sql"><code>-- ============================================================================
-- RADIANT v4.13.0 - Billing &amp; Credits Schema
-- Migration: 043_billing_system.sql
-- ============================================================================

-- Subscription Tiers
CREATE TABLE subscription_tiers (
    id VARCHAR(50) PRIMARY KEY,
    display_name VARCHAR(100) NOT NULL,
    description TEXT,
    
    price_monthly DECIMAL(10,2),
    price_annual DECIMAL(10,2),
    price_per_user BOOLEAN DEFAULT FALSE,
    min_users INTEGER DEFAULT 1,
    max_users INTEGER,
    currency VARCHAR(3) DEFAULT &#39;USD&#39;,
    
    included_credits_per_user DECIMAL(10,2) NOT NULL DEFAULT 0,
    
    requests_per_minute INTEGER NOT NULL,
    tokens_per_minute BIGINT NOT NULL,
    concurrent_requests INTEGER NOT NULL,
    
    features JSONB NOT NULL DEFAULT &#39;{}&#39;,
    available_add_ons TEXT[] DEFAULT &#39;{}&#39;,
    
    is_active BOOLEAN DEFAULT TRUE,
    is_public BOOLEAN DEFAULT TRUE,
    sort_order INTEGER DEFAULT 0,
    badge VARCHAR(50),
    
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Subscription Add-Ons
CREATE TABLE subscription_add_ons (
    id VARCHAR(50) PRIMARY KEY,
    display_name VARCHAR(100) NOT NULL,
    description TEXT,
    
    price_monthly_cents INTEGER NOT NULL,
    price_annual_cents INTEGER,
    price_per_user BOOLEAN DEFAULT FALSE,
    
    available_for_tiers TEXT[] NOT NULL,
    included_in_tiers TEXT[] DEFAULT &#39;{}&#39;,
    
    features JSONB NOT NULL DEFAULT &#39;{}&#39;,
    
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Credit Pools
CREATE TABLE credit_pools (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    pool_type VARCHAR(20) NOT NULL CHECK (pool_type IN (&#39;individual&#39;, &#39;family&#39;, &#39;team&#39;, &#39;organization&#39;, &#39;enterprise&#39;)),
    owner_user_id UUID NOT NULL REFERENCES users(id),
    organization_id UUID REFERENCES organizations(id),
    tenant_id UUID NOT NULL REFERENCES tenants(id),
    
    balance_available DECIMAL(12,4) NOT NULL DEFAULT 0,
    balance_reserved DECIMAL(12,4) NOT NULL DEFAULT 0,
    
    monthly_included_total DECIMAL(12,4) NOT NULL DEFAULT 0,
    monthly_included_used DECIMAL(12,4) NOT NULL DEFAULT 0,
    monthly_resets_at TIMESTAMPTZ,
    
    purchased_total DECIMAL(12,4) NOT NULL DEFAULT 0,
    purchased_remaining DECIMAL(12,4) NOT NULL DEFAULT 0,
    last_purchase_at TIMESTAMPTZ,
    
    bonus_total DECIMAL(12,4) NOT NULL DEFAULT 0,
    bonus_remaining DECIMAL(12,4) NOT NULL DEFAULT 0,
    
    settings JSONB NOT NULL DEFAULT &#39;{}&#39;,
    
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_credit_pools_owner ON credit_pools(owner_user_id);
CREATE INDEX idx_credit_pools_org ON credit_pools(organization_id);
CREATE INDEX idx_credit_pools_tenant ON credit_pools(tenant_id);

-- Credit Pool Members
CREATE TABLE credit_pool_members (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    pool_id UUID NOT NULL REFERENCES credit_pools(id) ON DELETE CASCADE,
    user_id UUID NOT NULL REFERENCES users(id),
    
    role VARCHAR(20) NOT NULL DEFAULT &#39;member&#39; CHECK (role IN (&#39;owner&#39;, &#39;admin&#39;, &#39;member&#39;, &#39;restricted&#39;)),
    permissions JSONB NOT NULL DEFAULT &#39;{}&#39;,
    
    daily_credit_limit DECIMAL(10,4),
    monthly_credit_limit DECIMAL(10,4),
    max_cost_per_request DECIMAL(10,4),
    
    status VARCHAR(20) NOT NULL DEFAULT &#39;active&#39; CHECK (status IN (&#39;active&#39;, &#39;invited&#39;, &#39;suspended&#39;)),
    invited_by UUID REFERENCES users(id),
    invited_at TIMESTAMPTZ,
    joined_at TIMESTAMPTZ,
    suspended_at TIMESTAMPTZ,
    suspended_reason TEXT,
    
    usage_today DECIMAL(12,4) NOT NULL DEFAULT 0,
    usage_this_week DECIMAL(12,4) NOT NULL DEFAULT 0,
    usage_this_month DECIMAL(12,4) NOT NULL DEFAULT 0,
    usage_all_time DECIMAL(12,4) NOT NULL DEFAULT 0,
    last_usage_at TIMESTAMPTZ,
    
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    
    UNIQUE(pool_id, user_id)
);

CREATE INDEX idx_pool_members_user ON credit_pool_members(user_id);
CREATE INDEX idx_pool_members_pool ON credit_pool_members(pool_id);

-- Credit Transactions
CREATE TABLE credit_transactions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    pool_id UUID NOT NULL REFERENCES credit_pools(id),
    user_id UUID REFERENCES users(id),
    
    transaction_type VARCHAR(30) NOT NULL CHECK (transaction_type IN (
        &#39;purchase&#39;, &#39;subscription_grant&#39;, &#39;bonus_grant&#39;, &#39;consumption&#39;,
        &#39;refund&#39;, &#39;adjustment&#39;, &#39;transfer_in&#39;, &#39;transfer_out&#39;, &#39;expiration&#39;
    )),
    
    amount DECIMAL(12,4) NOT NULL,
    balance_after DECIMAL(12,4) NOT NULL,
    
    source_type VARCHAR(30),
    source_id VARCHAR(100),
    
    model_id VARCHAR(100),
    request_id UUID,
    input_tokens INTEGER,
    output_tokens INTEGER,
    
    payment_intent_id VARCHAR(100),
    payment_amount_cents INTEGER,
    payment_currency VARCHAR(3),
    
    description TEXT,
    metadata JSONB DEFAULT &#39;{}&#39;,
    
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_credit_transactions_pool ON credit_transactions(pool_id);
CREATE INDEX idx_credit_transactions_user ON credit_transactions(user_id);
CREATE INDEX idx_credit_transactions_type ON credit_transactions(transaction_type);
CREATE INDEX idx_credit_transactions_created ON credit_transactions(created_at);

-- Credit Purchases
CREATE TABLE credit_purchases (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    pool_id UUID NOT NULL REFERENCES credit_pools(id),
    user_id UUID NOT NULL REFERENCES users(id),
    tenant_id UUID NOT NULL REFERENCES tenants(id),
    
    credits_amount DECIMAL(10,4) NOT NULL,
    bonus_credits DECIMAL(10,4) NOT NULL DEFAULT 0,
    total_credits DECIMAL(10,4) NOT NULL,
    
    payment_amount_cents INTEGER NOT NULL,
    payment_currency VARCHAR(3) NOT NULL DEFAULT &#39;USD&#39;,
    payment_method VARCHAR(50),
    
    stripe_payment_intent_id VARCHAR(100),
    stripe_charge_id VARCHAR(100),
    stripe_invoice_id VARCHAR(100),
    stripe_receipt_url TEXT,
    
    status VARCHAR(20) NOT NULL DEFAULT &#39;pending&#39; CHECK (status IN (
        &#39;pending&#39;, &#39;processing&#39;, &#39;completed&#39;, &#39;failed&#39;, &#39;refunded&#39;, &#39;partially_refunded&#39;
    )),
    completed_at TIMESTAMPTZ,
    failed_at TIMESTAMPTZ,
    failure_reason TEXT,
    
    is_auto_purchase BOOLEAN DEFAULT FALSE,
    auto_purchase_trigger VARCHAR(50),
    
    metadata JSONB DEFAULT &#39;{}&#39;,
    
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_credit_purchases_pool ON credit_purchases(pool_id);
CREATE INDEX idx_credit_purchases_user ON credit_purchases(user_id);
CREATE INDEX idx_credit_purchases_status ON credit_purchases(status);
CREATE INDEX idx_credit_purchases_stripe ON credit_purchases(stripe_payment_intent_id);

-- Subscriptions
CREATE TABLE subscriptions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    user_id UUID NOT NULL REFERENCES users(id),
    organization_id UUID REFERENCES organizations(id),
    tenant_id UUID NOT NULL REFERENCES tenants(id),
    credit_pool_id UUID REFERENCES credit_pools(id),
    
    tier_id VARCHAR(50) NOT NULL REFERENCES subscription_tiers(id),
    billing_cycle VARCHAR(10) NOT NULL CHECK (billing_cycle IN (&#39;monthly&#39;, &#39;annual&#39;)),
    
    seat_count INTEGER NOT NULL DEFAULT 1,
    add_ons JSONB NOT NULL DEFAULT &#39;[]&#39;,
    
    price_per_unit_cents INTEGER NOT NULL,
    total_price_cents INTEGER NOT NULL,
    currency VARCHAR(3) NOT NULL DEFAULT &#39;USD&#39;,
    
    stripe_subscription_id VARCHAR(100),
    stripe_customer_id VARCHAR(100) NOT NULL,
    stripe_price_id VARCHAR(100),
    
    current_period_start TIMESTAMPTZ NOT NULL,
    current_period_end TIMESTAMPTZ NOT NULL,
    trial_start TIMESTAMPTZ,
    trial_end TIMESTAMPTZ,
    
    status VARCHAR(20) NOT NULL DEFAULT &#39;active&#39; CHECK (status IN (
        &#39;trialing&#39;, &#39;active&#39;, &#39;past_due&#39;, &#39;canceled&#39;, &#39;unpaid&#39;, &#39;paused&#39;
    )),
    cancel_at_period_end BOOLEAN DEFAULT FALSE,
    canceled_at TIMESTAMPTZ,
    cancellation_reason TEXT,
    
    metadata JSONB DEFAULT &#39;{}&#39;,
    
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_subscriptions_user ON subscriptions(user_id);
CREATE INDEX idx_subscriptions_org ON subscriptions(organization_id);
CREATE INDEX idx_subscriptions_tenant ON subscriptions(tenant_id);
CREATE INDEX idx_subscriptions_stripe ON subscriptions(stripe_subscription_id);
CREATE INDEX idx_subscriptions_status ON subscriptions(status);

-- Auto-Purchase Settings
CREATE TABLE auto_purchase_settings (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    pool_id UUID NOT NULL REFERENCES credit_pools(id) UNIQUE,
    
    enabled BOOLEAN NOT NULL DEFAULT FALSE,
    threshold_credits DECIMAL(10,4) NOT NULL DEFAULT 1.0,
    purchase_credits DECIMAL(10,4) NOT NULL DEFAULT 10.0,
    max_monthly_auto_purchase DECIMAL(10,4),
    
    stripe_payment_method_id VARCHAR(100),
    
    auto_purchases_this_month INTEGER NOT NULL DEFAULT 0,
    auto_purchase_spend_this_month DECIMAL(10,2) NOT NULL DEFAULT 0,
    last_auto_purchase_at TIMESTAMPTZ,
    month_reset_at TIMESTAMPTZ,
    
    notify_on_auto_purchase BOOLEAN DEFAULT TRUE,
    notification_emails TEXT[],
    
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Credit Usage (for analytics)
CREATE TABLE credit_usage (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    pool_id UUID NOT NULL REFERENCES credit_pools(id),
    user_id UUID NOT NULL REFERENCES users(id),
    transaction_id UUID REFERENCES credit_transactions(id),
    
    request_id UUID NOT NULL,
    model_id VARCHAR(100) NOT NULL,
    provider_id VARCHAR(50) NOT NULL,
    
    input_tokens INTEGER NOT NULL DEFAULT 0,
    output_tokens INTEGER NOT NULL DEFAULT 0,
    cached_tokens INTEGER NOT NULL DEFAULT 0,
    
    credits_consumed DECIMAL(12,6) NOT NULL,
    credit_rate_multiplier DECIMAL(6,4) NOT NULL DEFAULT 1.0,
    
    credits_from_included DECIMAL(12,6) NOT NULL DEFAULT 0,
    credits_from_purchased DECIMAL(12,6) NOT NULL DEFAULT 0,
    credits_from_bonus DECIMAL(12,6) NOT NULL DEFAULT 0,
    
    request_type VARCHAR(50),
    latency_ms INTEGER,
    
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_credit_usage_pool ON credit_usage(pool_id);
CREATE INDEX idx_credit_usage_user ON credit_usage(user_id);
CREATE INDEX idx_credit_usage_model ON credit_usage(model_id);
CREATE INDEX idx_credit_usage_created ON credit_usage(created_at);

-- Billing Events
CREATE TABLE billing_events (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    event_type VARCHAR(50) NOT NULL,
    stripe_event_id VARCHAR(100),
    
    pool_id UUID REFERENCES credit_pools(id),
    user_id UUID REFERENCES users(id),
    subscription_id UUID REFERENCES subscriptions(id),
    purchase_id UUID REFERENCES credit_purchases(id),
    
    data JSONB NOT NULL DEFAULT &#39;{}&#39;,
    
    processed BOOLEAN DEFAULT FALSE,
    processed_at TIMESTAMPTZ,
    error TEXT,
    retry_count INTEGER DEFAULT 0,
    
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_billing_events_type ON billing_events(event_type);
CREATE INDEX idx_billing_events_processed ON billing_events(processed) WHERE processed = FALSE;
CREATE INDEX idx_billing_events_stripe ON billing_events(stripe_event_id);

-- Row Level Security
ALTER TABLE credit_pools ENABLE ROW LEVEL SECURITY;
ALTER TABLE credit_pool_members ENABLE ROW LEVEL SECURITY;
ALTER TABLE credit_transactions ENABLE ROW LEVEL SECURITY;
ALTER TABLE credit_purchases ENABLE ROW LEVEL SECURITY;
ALTER TABLE subscriptions ENABLE ROW LEVEL SECURITY;
ALTER TABLE credit_usage ENABLE ROW LEVEL SECURITY;

CREATE POLICY credit_pools_tenant_isolation ON credit_pools
    USING (tenant_id = current_setting(&#39;app.current_tenant_id&#39;)::UUID);

CREATE POLICY credit_pool_members_access ON credit_pool_members FOR SELECT
    USING (
        user_id = current_setting(&#39;app.current_user_id&#39;)::UUID OR
        pool_id IN (
            SELECT pool_id FROM credit_pool_members 
            WHERE user_id = current_setting(&#39;app.current_user_id&#39;)::UUID 
            AND role IN (&#39;owner&#39;, &#39;admin&#39;)
        )
    );</code></pre>
<hr />
<h2 id="credits-service">43.5 CREDITS SERVICE</h2>
<h3 id="packagesfunctionssrcservicescredits.ts">packages/functions/src/services/credits.ts</h3>
<pre class="typescript"><code>/**
 * Credits Service
 * Manages credit consumption, purchases, and balances
 * 
 * @version 4.13.0
 */

import { Pool } from &#39;pg&#39;;
import Stripe from &#39;stripe&#39;;
import { CREDIT_PRICING, calculatePurchasePrice } from &#39;@radiant/shared/billing/credits&#39;;

export class CreditsService {
  constructor(
    private pool: Pool,
    private stripe: Stripe
  ) {}

  async getBalance(userId: string): Promise&lt;{
    available: number;
    reserved: number;
    includedRemaining: number;
    purchasedRemaining: number;
    bonusRemaining: number;
  }&gt; {
    const result = await this.pool.query(`
      SELECT 
        cp.balance_available,
        cp.balance_reserved,
        cp.monthly_included_total - cp.monthly_included_used as included_remaining,
        cp.purchased_remaining,
        cp.bonus_remaining
      FROM credit_pools cp
      JOIN credit_pool_members cpm ON cpm.pool_id = cp.id
      WHERE cpm.user_id = $1 AND cpm.status = &#39;active&#39;
    `, [userId]);

    if (result.rows.length === 0) {
      return { available: 0, reserved: 0, includedRemaining: 0, purchasedRemaining: 0, bonusRemaining: 0 };
    }

    const row = result.rows[0];
    return {
      available: parseFloat(row.balance_available),
      reserved: parseFloat(row.balance_reserved),
      includedRemaining: parseFloat(row.included_remaining),
      purchasedRemaining: parseFloat(row.purchased_remaining),
      bonusRemaining: parseFloat(row.bonus_remaining),
    };
  }

  async reserveCredits(userId: string, amount: number): Promise&lt;boolean&gt; {
    const result = await this.pool.query(`
      UPDATE credit_pools cp
      SET 
        balance_available = balance_available - $2,
        balance_reserved = balance_reserved + $2,
        updated_at = NOW()
      FROM credit_pool_members cpm
      WHERE cpm.pool_id = cp.id
        AND cpm.user_id = $1
        AND cpm.status = &#39;active&#39;
        AND cp.balance_available &gt;= $2
      RETURNING cp.id
    `, [userId, amount]);

    return result.rowCount &gt; 0;
  }

  async consumeCredits(
    userId: string,
    modelId: string,
    inputTokens: number,
    outputTokens: number,
    requestId: string
  ): Promise&lt;{ consumed: number; remaining: number }&gt; {
    const creditCost = this.calculateCreditCost(modelId, inputTokens, outputTokens);
    
    const client = await this.pool.connect();
    try {
      await client.query(&#39;BEGIN&#39;);

      // Consume from reserved first, then available
      const consumeResult = await client.query(`
        UPDATE credit_pools cp
        SET 
          balance_reserved = GREATEST(0, balance_reserved - $2),
          balance_available = CASE 
            WHEN balance_reserved &gt;= $2 THEN balance_available
            ELSE balance_available - ($2 - balance_reserved)
          END,
          updated_at = NOW()
        FROM credit_pool_members cpm
        WHERE cpm.pool_id = cp.id
          AND cpm.user_id = $1
          AND cpm.status = &#39;active&#39;
        RETURNING cp.id, cp.balance_available
      `, [userId, creditCost]);

      if (consumeResult.rows.length === 0) {
        throw new Error(&#39;No active credit pool found&#39;);
      }

      // Record transaction
      await client.query(`
        INSERT INTO credit_transactions (
          pool_id, user_id, transaction_type, amount, balance_after,
          model_id, request_id, input_tokens, output_tokens
        ) VALUES ($1, $2, &#39;consumption&#39;, $3, $4, $5, $6, $7, $8)
      `, [
        consumeResult.rows[0].id, userId, -creditCost,
        consumeResult.rows[0].balance_available, modelId, requestId,
        inputTokens, outputTokens
      ]);

      // Record usage for analytics
      await client.query(`
        INSERT INTO credit_usage (
          pool_id, user_id, request_id, model_id, provider_id,
          input_tokens, output_tokens, credits_consumed
        ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8)
      `, [
        consumeResult.rows[0].id, userId, requestId, modelId, &#39;auto&#39;,
        inputTokens, outputTokens, creditCost
      ]);

      // Update member usage stats
      await client.query(`
        UPDATE credit_pool_members
        SET 
          usage_today = usage_today + $2,
          usage_this_month = usage_this_month + $2,
          usage_all_time = usage_all_time + $2,
          last_usage_at = NOW(),
          updated_at = NOW()
        WHERE user_id = $1
      `, [userId, creditCost]);

      await client.query(&#39;COMMIT&#39;);

      return {
        consumed: creditCost,
        remaining: parseFloat(consumeResult.rows[0].balance_available),
      };
    } catch (error) {
      await client.query(&#39;ROLLBACK&#39;);
      throw error;
    } finally {
      client.release();
    }
  }

  async purchaseCredits(
    userId: string,
    poolId: string,
    credits: number,
    paymentMethodId: string
  ): Promise&lt;{ purchaseId: string; totalCredits: number }&gt; {
    const pricing = calculatePurchasePrice(credits);
    
    // Create Stripe payment intent
    const paymentIntent = await this.stripe.paymentIntents.create({
      amount: Math.round(pricing.finalPrice * 100),
      currency: &#39;usd&#39;,
      payment_method: paymentMethodId,
      confirm: true,
      metadata: {
        poolId,
        userId,
        credits: credits.toString(),
        bonusCredits: pricing.bonusCredits.toString(),
      },
    });

    // Record purchase
    const result = await this.pool.query(`
      INSERT INTO credit_purchases (
        pool_id, user_id, tenant_id,
        credits_amount, bonus_credits, total_credits,
        payment_amount_cents, stripe_payment_intent_id,
        status, completed_at
      )
      SELECT 
        $1, $2, cp.tenant_id,
        $3, $4, $5, $6, $7, &#39;completed&#39;, NOW()
      FROM credit_pools cp WHERE cp.id = $1
      RETURNING id
    `, [
      poolId, userId,
      credits, pricing.bonusCredits, pricing.totalCredits,
      Math.round(pricing.finalPrice * 100), paymentIntent.id
    ]);

    // Add credits to pool
    await this.pool.query(`
      UPDATE credit_pools
      SET 
        purchased_total = purchased_total + $2,
        purchased_remaining = purchased_remaining + $2,
        bonus_total = bonus_total + $3,
        bonus_remaining = bonus_remaining + $3,
        balance_available = balance_available + $2 + $3,
        last_purchase_at = NOW(),
        updated_at = NOW()
      WHERE id = $1
    `, [poolId, credits, pricing.bonusCredits]);

    return {
      purchaseId: result.rows[0].id,
      totalCredits: pricing.totalCredits,
    };
  }

  private calculateCreditCost(modelId: string, inputTokens: number, outputTokens: number): number {
    const inputCredits = inputTokens / CREDIT_PRICING.consumption.text.inputTokensPer1Credit;
    const outputCredits = outputTokens / CREDIT_PRICING.consumption.text.outputTokensPer1Credit;
    return inputCredits + outputCredits;
  }
}</code></pre>
<hr />
<h1 id="section-1">â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</h1>

  
  <div class="footer">
    RADIANT Documentation | Version 5.52.29 | Generated January 25, 2026
  </div>
</body>
</html>