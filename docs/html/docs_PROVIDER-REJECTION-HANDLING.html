<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PROVIDER REJECTION HANDLING - RADIANT Documentation</title>
  
<style>
@media print {
  body { font-size: 11pt !important; }
  pre { page-break-inside: avoid; }
  h1, h2, h3 { page-break-after: avoid; }
  .no-print { display: none !important; }
}

* { box-sizing: border-box; }

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  line-height: 1.7;
  color: #1d1d1f;
  max-width: 900px;
  margin: 0 auto;
  padding: 40px 30px;
  background: white;
}

h1 {
  color: #1d1d1f;
  border-bottom: 3px solid #0071e3;
  padding-bottom: 12px;
  font-size: 28px;
  margin-top: 0;
}

h2 {
  color: #1d1d1f;
  border-bottom: 1px solid #d2d2d7;
  padding-bottom: 8px;
  font-size: 22px;
  margin-top: 40px;
}

h3 { color: #1d1d1f; font-size: 18px; margin-top: 30px; }
h4 { color: #1d1d1f; font-size: 16px; margin-top: 25px; }

a { color: #0071e3; text-decoration: none; }
a:hover { text-decoration: underline; }

code {
  background: #f5f5f7;
  padding: 2px 6px;
  border-radius: 4px;
  font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
  font-size: 0.9em;
  color: #1d1d1f;
}

pre {
  background: #1d1d1f;
  color: #f5f5f7;
  padding: 20px;
  border-radius: 10px;
  overflow-x: auto;
  font-size: 13px;
  line-height: 1.5;
}

pre code {
  background: transparent;
  padding: 0;
  color: inherit;
}

table {
  width: 100%;
  border-collapse: collapse;
  margin: 20px 0;
  font-size: 14px;
}

th, td {
  border: 1px solid #d2d2d7;
  padding: 12px 15px;
  text-align: left;
}

th {
  background: #0071e3;
  color: white;
  font-weight: 600;
}

tr:nth-child(even) { background: #f5f5f7; }

blockquote {
  border-left: 4px solid #0071e3;
  margin: 20px 0;
  padding: 15px 25px;
  background: #f5f5f7;
  border-radius: 0 8px 8px 0;
}

blockquote p { margin: 0; }

img { max-width: 100%; height: auto; border-radius: 8px; }

hr {
  border: none;
  border-top: 1px solid #d2d2d7;
  margin: 40px 0;
}

ul, ol { padding-left: 25px; }
li { margin: 8px 0; }

.header-bar {
  background: linear-gradient(135deg, #0071e3 0%, #00c6ff 100%);
  color: white;
  padding: 20px 30px;
  margin: -40px -30px 30px -30px;
  border-radius: 0 0 16px 16px;
}

.header-bar h1 {
  color: white;
  border: none;
  margin: 0;
  padding: 0;
}

.header-bar .meta {
  font-size: 13px;
  opacity: 0.9;
  margin-top: 8px;
}

.print-btn {
  position: fixed;
  top: 20px;
  right: 20px;
  background: #0071e3;
  color: white;
  border: none;
  padding: 12px 24px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
  box-shadow: 0 4px 12px rgba(0,113,227,0.3);
}

.print-btn:hover { background: #0077ed; }

.mermaid {
  background: #f5f5f7;
  padding: 20px;
  border-radius: 10px;
  text-align: center;
  margin: 20px 0;
}

.footer {
  margin-top: 60px;
  padding-top: 20px;
  border-top: 1px solid #d2d2d7;
  color: #86868b;
  font-size: 12px;
  text-align: center;
}
</style>

</head>
<body>
  <button class="print-btn no-print" onclick="window.print()">üñ®Ô∏è Print / Save as PDF</button>
  
  <div class="header-bar">
    <h1>PROVIDER REJECTION HANDLING</h1>
    <div class="meta">RADIANT v5.52.29 | docs/PROVIDER-REJECTION-HANDLING.md</div>
  </div>
  
  <h1 id="provider-rejection-handling-intelligent-fallback">Provider Rejection Handling &amp; Intelligent Fallback</h1>
<p><strong>Version</strong>: 4.18.3<br />
<strong>Last Updated</strong>: 2024-12-28</p>
<h2 id="overview">Overview</h2>
<p>When an AI provider or self-hosted model rejects a prompt based on their ethics policies (that don‚Äôt conflict with RADIANT‚Äôs ethics), the system automatically attempts fallback to alternative models. If all capable models reject the request, the user receives a clear explanation.</p>
<hr />
<h2 id="how-it-works">How It Works</h2>
<h3 id="rejection-flow">Rejection Flow</h3>
<pre><code>1. User submits prompt
2. AGI Brain selects optimal model
3. Model rejects prompt (provider ethics, content policy, etc.)
4. System checks: Does this violate OUR ethics?
   ‚îú‚îÄ‚îÄ YES ‚Üí Reject to user with explanation
   ‚îî‚îÄ‚îÄ NO ‚Üí Try fallback models
5. Fallback loop (max 3 attempts):
   ‚îú‚îÄ‚îÄ Select model with lowest rejection rate
   ‚îú‚îÄ‚îÄ Attempt request
   ‚îî‚îÄ‚îÄ If success ‚Üí Return response
6. If all fallbacks fail:
   ‚îî‚îÄ‚îÄ Reject to user with detailed explanation</code></pre>
<h3 id="key-principles">Key Principles</h3>
<ol type="1">
<li><strong>RADIANT ethics take precedence</strong> - If our ethics block it, no fallback is attempted</li>
<li><strong>Provider ethics don‚Äôt block us</strong> - Different providers have different policies; we route around them</li>
<li><strong>Users always know</strong> - Every rejection is explained to the user</li>
<li><strong>Learning from patterns</strong> - The system learns which models reject which types of content</li>
</ol>
<hr />
<h2 id="rejection-types">Rejection Types</h2>
<table>
<colgroup>
<col style="width: 20%" />
<col style="width: 43%" />
<col style="width: 36%" />
</colgroup>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
<th>Fallback?</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>content_policy</code></td>
<td>Provider‚Äôs content policy violation</td>
<td>‚úÖ Yes</td>
</tr>
<tr>
<td><code>safety_filter</code></td>
<td>Safety/moderation filter triggered</td>
<td>‚úÖ Yes</td>
</tr>
<tr>
<td><code>provider_ethics</code></td>
<td>Provider‚Äôs ethical guidelines differ</td>
<td>‚úÖ Yes</td>
</tr>
<tr>
<td><code>capability_mismatch</code></td>
<td>Model can‚Äôt handle this request type</td>
<td>‚úÖ Yes</td>
</tr>
<tr>
<td><code>context_length</code></td>
<td>Prompt too long for model</td>
<td>‚úÖ Yes</td>
</tr>
<tr>
<td><code>moderation</code></td>
<td>Pre-flight moderation blocked</td>
<td>‚úÖ Yes</td>
</tr>
<tr>
<td><code>rate_limit</code></td>
<td>Rate limiting (retry later)</td>
<td>‚è≥ Retry</td>
</tr>
<tr>
<td><code>unknown</code></td>
<td>Unknown error</td>
<td>‚úÖ Yes</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="fallback-model-selection">Fallback Model Selection</h2>
<p>Models are selected for fallback based on:</p>
<ol type="1">
<li><strong>Rejection rate</strong> - Models with lowest historical rejection rates preferred</li>
<li><strong>Required capabilities</strong> - Must have same capabilities as original</li>
<li><strong>Exclusion list</strong> - Previously tried models excluded</li>
<li><strong>Provider diversity</strong> - Prefer different providers for better success chance</li>
</ol>
<h3 id="selection-query">Selection Query</h3>
<pre class="sql"><code>SELECT model_id, provider_id, rejection_rate
FROM unified_model_registry m
LEFT JOIN model_rejection_stats s ON m.model_id = s.model_id
WHERE m.enabled = true
  AND m.model_id != ALL(excluded_models)
  AND m.capabilities &amp;&amp; required_capabilities
ORDER BY COALESCE(s.rejection_rate, 0) ASC
LIMIT 10</code></pre>
<hr />
<h2 id="user-notifications">User Notifications</h2>
<h3 id="notification-types">Notification Types</h3>
<p><strong>Rejected Request</strong>:</p>
<pre><code>Title: Request Could Not Be Completed
Message: The ethical guidelines of available AI providers prevented 
         this response. We attempted 3 different AI models.
Suggested Actions:
  - Try rephrasing your request
  - Remove potentially sensitive content
  - Contact administrator</code></pre>
<p><strong>Resolved with Fallback</strong>:</p>
<pre><code>Title: Resolved with Alternative Model
Message: Your request was processed by an alternative AI model 
         after the original was unavailable.</code></pre>
<h3 id="think-tank-ui">Think Tank UI</h3>
<ul>
<li><strong>Bell icon</strong> with unread count in toolbar</li>
<li><strong>Sheet panel</strong> slides out showing all notifications</li>
<li><strong>Rejection banners</strong> appear in conversation when relevant</li>
<li><strong>Suggested actions</strong> are clickable to help users resolve issues</li>
</ul>
<hr />
<h2 id="database-schema">Database Schema</h2>
<h3 id="provider_rejections">provider_rejections</h3>
<table>
<thead>
<tr>
<th>Column</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>id</code></td>
<td>UUID</td>
<td>Primary key</td>
</tr>
<tr>
<td><code>tenant_id</code></td>
<td>UUID</td>
<td>Multi-tenant isolation</td>
</tr>
<tr>
<td><code>user_id</code></td>
<td>UUID</td>
<td>User who made request</td>
</tr>
<tr>
<td><code>plan_id</code></td>
<td>UUID</td>
<td>AGI Brain plan if applicable</td>
</tr>
<tr>
<td><code>model_id</code></td>
<td>VARCHAR</td>
<td>Model that rejected</td>
</tr>
<tr>
<td><code>provider_id</code></td>
<td>VARCHAR</td>
<td>Provider ID</td>
</tr>
<tr>
<td><code>rejection_type</code></td>
<td>VARCHAR</td>
<td>Type of rejection</td>
</tr>
<tr>
<td><code>rejection_message</code></td>
<td>TEXT</td>
<td>Raw error from provider</td>
</tr>
<tr>
<td><code>radiant_ethics_passed</code></td>
<td>BOOLEAN</td>
<td>Did it pass our ethics?</td>
</tr>
<tr>
<td><code>fallback_attempted</code></td>
<td>BOOLEAN</td>
<td>Was fallback tried?</td>
</tr>
<tr>
<td><code>fallback_model_id</code></td>
<td>VARCHAR</td>
<td>Model that succeeded</td>
</tr>
<tr>
<td><code>fallback_succeeded</code></td>
<td>BOOLEAN</td>
<td>Did fallback work?</td>
</tr>
<tr>
<td><code>fallback_chain</code></td>
<td>JSONB</td>
<td>Array of all attempts</td>
</tr>
<tr>
<td><code>final_status</code></td>
<td>VARCHAR</td>
<td>pending, fallback_success, rejected</td>
</tr>
<tr>
<td><code>final_response_to_user</code></td>
<td>TEXT</td>
<td>Message shown to user</td>
</tr>
</tbody>
</table>
<h3 id="rejection_patterns">rejection_patterns</h3>
<p>Learns patterns for smarter fallback:</p>
<table>
<thead>
<tr>
<th>Column</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>pattern_hash</code></td>
<td>VARCHAR</td>
<td>Hash of rejection characteristics</td>
</tr>
<tr>
<td><code>trigger_keywords</code></td>
<td>TEXT[]</td>
<td>Keywords that trigger rejections</td>
</tr>
<tr>
<td><code>trigger_model_ids</code></td>
<td>TEXT[]</td>
<td>Models that reject this pattern</td>
</tr>
<tr>
<td><code>recommended_fallback_models</code></td>
<td>TEXT[]</td>
<td>Models that work</td>
</tr>
<tr>
<td><code>success_rate</code></td>
<td>NUMERIC</td>
<td>Fallback success rate</td>
</tr>
</tbody>
</table>
<h3 id="model_rejection_stats">model_rejection_stats</h3>
<p>Per-model rejection statistics:</p>
<table>
<thead>
<tr>
<th>Column</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>model_id</code></td>
<td>VARCHAR</td>
<td>Model identifier</td>
</tr>
<tr>
<td><code>total_requests</code></td>
<td>INTEGER</td>
<td>Total requests to model</td>
</tr>
<tr>
<td><code>total_rejections</code></td>
<td>INTEGER</td>
<td>Total rejections</td>
</tr>
<tr>
<td><code>rejection_rate</code></td>
<td>NUMERIC</td>
<td>Computed rejection rate</td>
</tr>
<tr>
<td><code>content_policy_count</code></td>
<td>INTEGER</td>
<td>By type breakdown</td>
</tr>
<tr>
<td><code>fallback_successes</code></td>
<td>INTEGER</td>
<td>Successful fallbacks</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="api-endpoints">API Endpoints</h2>
<h3 id="record-rejection">Record Rejection</h3>
<pre><code>POST /api/internal/rejections
{
  &quot;modelId&quot;: &quot;gpt-4&quot;,
  &quot;providerId&quot;: &quot;openai&quot;,
  &quot;rejectionType&quot;: &quot;content_policy&quot;,
  &quot;rejectionMessage&quot;: &quot;Content policy violation&quot;,
  &quot;planId&quot;: &quot;uuid&quot;
}</code></pre>
<h3 id="get-user-notifications">Get User Notifications</h3>
<pre><code>GET /api/thinktank/rejections
Response: {
  &quot;notifications&quot;: [...],
  &quot;unreadCount&quot;: 3
}</code></pre>
<h3 id="mark-notification-read">Mark Notification Read</h3>
<pre><code>PATCH /api/thinktank/rejections/:id/read</code></pre>
<h3 id="dismiss-notification">Dismiss Notification</h3>
<pre><code>DELETE /api/thinktank/rejections/:id</code></pre>
<hr />
<h2 id="service-integration">Service Integration</h2>
<h3 id="providerrejectionservice">ProviderRejectionService</h3>
<pre class="typescript"><code>// Handle rejection with automatic fallback
const result = await providerRejectionService.handleRejectionWithFallback(
  tenantId,
  userId,
  originalModelId,
  providerId,
  rejectionType,
  rejectionMessage,
  async (modelId, providerId) =&gt; {
    // Execute request with fallback model
    return await executeRequest(modelId, providerId, prompt);
  },
  planId,
  requiredCapabilities
);

if (result.success) {
  // Request succeeded (possibly with fallback)
  console.log(&#39;Handled by:&#39;, result.handlingModelId);
  console.log(&#39;Used fallback:&#39;, result.usedFallback);
} else {
  // All models rejected
  console.log(&#39;Rejection reason:&#39;, result.rejectionReason);
  console.log(&#39;User message:&#39;, result.userFacingMessage);
}</code></pre>
<h3 id="agi-brain-integration">AGI Brain Integration</h3>
<p>The AGI Brain Planner automatically uses rejection handling:</p>
<ol type="1">
<li>Selects optimal model for task</li>
<li>If model rejects, calls <code>providerRejectionService.handleRejectionWithFallback()</code></li>
<li>If fallback succeeds, continues with new model</li>
<li>If all fail, returns rejection response to user</li>
</ol>
<hr />
<h2 id="configuration">Configuration</h2>
<h3 id="constants">Constants</h3>
<pre class="typescript"><code>const MIN_MODELS_FOR_TASK = 2;   // Minimum models needed
const MAX_FALLBACK_ATTEMPTS = 3; // Maximum fallback tries</code></pre>
<h3 id="model-rejection-thresholds">Model Rejection Thresholds</h3>
<p>Models with rejection rates above 30% are deprioritized for initial selection but may still be used as fallbacks.</p>
<hr />
<h2 id="admin-dashboard">Admin Dashboard</h2>
<h3 id="rejection-analytics">Rejection Analytics</h3>
<p><strong>Location</strong>: Admin Dashboard ‚Üí Analytics ‚Üí Rejections</p>
<p>Full analytics dashboard for monitoring rejections and informing policy updates.</p>
<h4 id="summary-cards">Summary Cards</h4>
<ul>
<li><strong>Total Rejections (30d)</strong> - All rejections in period</li>
<li><strong>Fallback Success Rate</strong> - Percentage resolved via fallback</li>
<li><strong>Rejected to User</strong> - Requests that failed all fallbacks</li>
<li><strong>Flagged Keywords</strong> - Keywords marked for policy review</li>
</ul>
<h4 id="tabs">Tabs</h4>
<table>
<colgroup>
<col style="width: 35%" />
<col style="width: 64%" />
</colgroup>
<thead>
<tr>
<th>Tab</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>By Provider</strong></td>
<td>See which providers reject most, rejection types, fallback rates</td>
</tr>
<tr>
<td><strong>Violation Keywords</strong></td>
<td>Keywords triggering rejections, per-provider breakdown</td>
</tr>
<tr>
<td><strong>Flagged Prompts</strong></td>
<td>Full prompt content for policy investigation</td>
</tr>
<tr>
<td><strong>Policy Review</strong></td>
<td>Recommendations for pre-filters based on patterns</td>
</tr>
</tbody>
</table>
<h3 id="viewing-full-prompt-content">Viewing Full Prompt Content</h3>
<p>Administrators can view the complete rejected prompt to understand why it was rejected:</p>
<ol type="1">
<li>Go to Analytics ‚Üí Rejections ‚Üí Flagged Prompts</li>
<li>Click ‚ÄúView Full Prompt‚Äù on any entry</li>
<li>Review detected keywords and rejection reason</li>
<li>Decide: Add Pre-Filter, Add Warning, or Dismiss</li>
</ol>
<h3 id="adding-pre-filters">Adding Pre-Filters</h3>
<p>Based on rejection patterns, add pre-filters to RADIANT‚Äôs ethics:</p>
<ol type="1">
<li>Identify high-frequency rejection keywords</li>
<li>Flag keywords for review</li>
<li>Investigate sample prompts</li>
<li>Add pre-filter rule to block before sending to AI</li>
</ol>
<h3 id="database-views">Database Views</h3>
<table>
<thead>
<tr>
<th>View</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>rejection_summary_by_provider</code></td>
<td>Aggregated stats per provider</td>
</tr>
<tr>
<td><code>rejection_summary_by_model</code></td>
<td>Aggregated stats per model</td>
</tr>
<tr>
<td><code>top_rejection_keywords</code></td>
<td>Most frequent violation keywords</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="related-documentation">Related Documentation</h2>
<ul>
<li><a href="./sections/SECTION-XX-AGI-BRAIN-PLAN.md">AGI Brain Plan System</a></li>
<li><a href="./AI-ETHICS-STANDARDS.md">AI Ethics Standards</a></li>
<li><a href="./MODEL-ROUTER.md">Model Router Service</a></li>
</ul>

  
  <div class="footer">
    RADIANT Documentation | Version 5.52.29 | Generated January 25, 2026
  </div>
</body>
</html>